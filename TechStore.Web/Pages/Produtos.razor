@page "/produtos"
@using TechStore.Web.Services
@using Microsoft.AspNetCore.Components
@inject HttpClient Http
@inject NavigationManager Navigation
@inject CarrinhoService Carrinho
@inject AuthService Auth


<PageTitle>TechStore - Produtos</PageTitle>

<!-- CABEÇALHO DA PÁGINA -->
<section class="bg-dark text-white p-4 rounded shadow mb-4">
    <div class="container text-center">
        <h1 class="fw-bold">Catálogo de Produtos</h1>
        <p class="lead mb-0">Confira os melhores produtos de tecnologia</p>
    </div>
</section>

@if (carregando)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 fs-5">Carregando produtos...</p>
    </div>
}
else if (erro != null)
{
    <div class="alert alert-danger shadow">
        <h4>Erro ao carregar produtos</h4>
        <p>@erro</p>
    </div>
}
else
{
    <div class="row g-4">

        @foreach (var produto in produtos)
        {
            <div class="col-md-4">
                <div class="card h-100 shadow-sm border-0 produto-card">

                    <!-- IMAGEM PLACEHOLDER -->
                    <img src="https://via.placeholder.com/400x250"
                         class="card-img-top">

                    <div class="card-body d-flex flex-column">

                        <h5 class="card-title fw-bold">
                            @produto.nome
                        </h5>

                        <p class="card-text text-muted flex-grow-1">
                            @GetDescricaoResumida(produto.descricao)
                        </p>

                        <div class="d-flex justify-content-between align-items-center mt-3">

                            <span class="h4 text-success fw-bold mb-0">
                                R$ @produto.preco.ToString("N2")
                            </span>

                            <span class="badge @(produto.quantidadeEstoque > 0 ? "bg-success" : "bg-danger") fs-6">
                                @(produto.quantidadeEstoque > 0 ? "Em estoque" : "Esgotado")
                            </span>

                        </div>

                        <button class="btn btn-primary w-100 mt-3"
                                @onclick="() => VerDetalhes(produto.id)">
                            <i class="bi bi-eye"></i> Ver Detalhes
                        </button>

                        <button class="btn btn-outline-success w-100 mt-2"
                                disabled="@(produto.quantidadeEstoque == 0)"
                                @onclick="() => AdicionarAoCarrinho(produto.id)">
                            <i class="bi bi-cart-plus"></i> Adicionar ao Carrinho
                        </button>
                    </div>
                </div>
            </div>
        }

    </div>
}

<style>
    .produto-card:hover {
        transform: scale(1.02);
        transition: 0.2s ease-in-out;
    }
</style>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string? SearchTerm { get; set; }

    private class Produto
    {
        public int id { get; set; }
        public string? nome { get; set; }
        public string? descricao { get; set; }
        public decimal preco { get; set; }
        public int quantidadeEstoque { get; set; }
    }

    private List<Produto> produtos = new();
    private bool carregando = true;
    private string? erro;

    protected override async Task OnInitializedAsync()
    {
        await CarregarProdutos();

        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            produtos = produtos
                .Where(p => p.nome != null &&
                            p.nome.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private async Task CarregarProdutos()
    {
        try
        {
            carregando = true;

            var resposta = await Http.GetFromJsonAsync<List<Produto>>("api/produtos");

            if (resposta != null)
                produtos = resposta;
        }
        catch (Exception ex)
        {
            erro = $"Não foi possível carregar os produtos: {ex.Message}";
        }
        finally
        {
            carregando = false;
        }
    }

    private string GetDescricaoResumida(string? descricao)
    {
        if (string.IsNullOrEmpty(descricao))
            return "Sem descrição disponível";

        if (descricao.Length > 100)
            return descricao.Substring(0, 100) + "...";

        return descricao;
    }

    private void VerDetalhes(int id)
    {
        Navigation.NavigateTo($"/produto/{id}");
    }

    private async Task AdicionarAoCarrinho(int produtoId)
    {
        if (!Auth.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var sucesso = await Carrinho.AdicionarItemAsync(produtoId);

        if (!sucesso)
        {
            erro = "Não foi possível adicionar o produto ao carrinho.";
        }
    }

}
